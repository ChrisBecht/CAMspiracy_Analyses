---
title: "Analyzes for Bachelor Theses"
author: "Julius Fenn"
format:
  html:
    toc: true
    toc-depth: 3
    html-math-method: katex
---


# Notes


# global variables

```{r}
## global variables: 


```



# load merged pre-processed data

```{r}
#| echo: true
#| warning: false

# sets the directory of location of this script as the current directory
# setwd(dirname(rstudioapi::getSourceEditorContext()$path))

# load packages
require(pacman)
# regsem not needed!
p_load('tidyverse', 'jsonlite', 'magrittr', 'xlsx',
       'stargazer', 'psych', 'jtools', 'DT', 'ggstatsplot', 
       'lavaan', 'igraph',
       'regsem', 'MplusAutomation')


# load data
setwd("outputs")
t12_questionnaireCAMs <- readRDS(file = "t12_questionnaireCAMs.rds")
CAMfiles <- readRDS(file = "CAMfiles.rds")
CAMdrawn <- readRDS(file = "CAMdrawn.rds")


t12_questionnaireCAMs$total_min_prolific[t12_questionnaireCAMs$total_min_prolific > 1000] <- NA


# load functions
setwd("../../functions")
for(i in 1:length(dir())){
  # print(dir()[i])
  source(dir()[i], encoding = "utf-8")
}


setwd("../functions_CAMapp")
for(i in 1:length(dir())){
  # print(dir()[i])
  source(dir()[i], encoding = "utf-8")
}
rm(i)
```


# Laras BA

## policy scale


```{r}
#| echo: true
#| warning: false


regEx <- "^policyItems"
nameScale <- "Policy Scale"
nameVariable <- "mean_PolicyItems"

### number of items
sum(str_detect(string = colnames(t12_questionnaireCAMs), pattern = regEx))

### only keep values with no missing values
tmp_dat <- t12_questionnaireCAMs[, c(str_subset(string = colnames(t12_questionnaireCAMs), pattern = regEx), "country.y")]

# tmp_dat <- tmp_dat[!is.na(tmp_dat$country.y), ]
tmp_dat <- tmp_dat[tmp_dat$country.y == "Germany" & !is.na(tmp_dat$country.y), ]
cat("analyes for country/ies:\n", unique(tmp_dat$country.y), "\n")

### get correlation plot, descriptives, EFA, CFA
tmp <- CFAstats(dataset = tmp_dat, regularExp = regEx, labelLatent = str_remove(string = nameVariable, pattern = "mean_"), 
                showPlots = TRUE, 
                computeEFA = TRUE, 
                computeCFA = TRUE, 
                computeCFAMplus = FALSE)

# ### variable mean
# questionnaireCAMs[[nameVariable]]  <- questionnaireCAMs %>%
#   select(matches(regEx)) %>%
#   rowMeans(na.rm = TRUE)
```


# Amelies BA


## split into CAMs from Germany

```{r}
setwd("outputs/BA_Amelie")
if(!file.exists("CAMs_Germany")){
  dir.create("CAMs_Germany")
}
setwd("CAMs_Germany")


CAMfiles_Germany <- CAMfiles

## check is ID data set is complete
if(!all(CAMfiles_Germany[[1]]$participantCAM %in% t12_questionnaireCAMs$PROLIFIC_PID)){
    print("Error")
}else{
  tmp_ids <- t12_questionnaireCAMs$PROLIFIC_PID[t12_questionnaireCAMs$country.x == "Germany"]
  
  ## keep only CAM data from Germany
  CAMfiles_Germany[[1]] <- CAMfiles_Germany[[1]][CAMfiles_Germany[[1]]$participantCAM %in% tmp_ids,]
  CAMfiles_Germany[[2]] <- CAMfiles_Germany[[2]][CAMfiles_Germany[[2]]$participantCAM %in% tmp_ids,]
  CAMfiles_Germany[[3]] <- CAMfiles_Germany[[3]][CAMfiles_Germany[[3]]$participantCAM.x %in% tmp_ids,]
  
  ## save files ob subsets
  vroom::vroom_write(x =  CAMfiles_Germany[[1]], file = "CAM_nodes_Germany.txt")
  vroom::vroom_write(x =  CAMfiles_Germany[[2]], file = "CAM_connectors_Germany.txt")
  vroom::vroom_write(x =  CAMfiles_Germany[[3]], file = "CAM_merged_Germany.txt")
}
```



## split into CAMs from Germany


```{r}
setwd("outputs/BA_Amelie")
if(!file.exists("CAMs_USA")){
  dir.create("CAMs_USA")
}
setwd("CAMs_USA")


CAMfiles_USA <- CAMfiles

## check is ID data set is complete
if(!all(CAMfiles_USA[[1]]$participantCAM %in% t12_questionnaireCAMs$PROLIFIC_PID)){
    print("Error")
}else{
  tmp_ids <- t12_questionnaireCAMs$PROLIFIC_PID[t12_questionnaireCAMs$country.x == "USA"]
  
  ## keep only CAM data from Germany
  CAMfiles_USA[[1]] <- CAMfiles_USA[[1]][CAMfiles_USA[[1]]$participantCAM %in% tmp_ids,]
  CAMfiles_USA[[2]] <- CAMfiles_USA[[2]][CAMfiles_USA[[2]]$participantCAM %in% tmp_ids,]
  CAMfiles_USA[[3]] <- CAMfiles_USA[[3]][CAMfiles_USA[[3]]$participantCAM.x %in% tmp_ids,]
  
  ## save files ob subsets
  vroom::vroom_write(x =  CAMfiles_USA[[1]], file = "CAM_nodes_USA.txt")
  vroom::vroom_write(x =  CAMfiles_USA[[2]], file = "CAM_connectors_USA.txt")
  vroom::vroom_write(x =  CAMfiles_USA[[3]], file = "CAM_merged_USA.txt")
}
```

# Magdalenas BA

## get the first 8 concepts drawn in CAMs


```{r}
#| echo: true
#| warning: false


### only keep t2
tmp_dat <- t12_questionnaireCAMs[!is.na(t12_questionnaireCAMs$country.y), ]


affectiveImagery_CAMs <- tmp_dat[, c("PROLIFIC_PID", "country.y", "classes_conspiracy", "politicalParty", "socio_sex",
  "mean_affImg", "mean_valence_macro", "num_nodes_macro",
  str_subset(string = colnames(tmp_dat), pattern = "^R[:digit:]"), 
  sort(str_subset(string = colnames(tmp_dat), pattern = "^affImg")))]
sum(is.na(affectiveImagery_CAMs$mean_affImg))

affectiveImagery_CAMs[, paste0("A", 1:8)] <- NA

for(i in 1:nrow(tmp_dat)){
  tmp_concepts <- CAMfiles[[1]][CAMfiles[[1]]$participantCAM == tmp_dat$PROLIFIC_PID[i],]
  tmp_concepts <- tmp_concepts$text[order(tmp_concepts$date, decreasing = FALSE)][2:9]
  
  affectiveImagery_CAMs[i, str_subset(string = colnames(affectiveImagery_CAMs), pattern = "^A")] <- tmp_concepts
}

### save data set
setwd("outputs/BA_Magdalena")
if(!file.exists("data_AffImg_CAMs")){
  dir.create("data_AffImg_CAMs")
}
setwd("data_AffImg_CAMs")

## save as .xlsx file
xlsx::write.xlsx2(x = affectiveImagery_CAMs, file = "affectiveImagery_CAMs.xlsx")
## save as .csv file
write.csv2(x = affectiveImagery_CAMs, file = "affectiveImagery_CAMs.csv")
## save as R object
saveRDS(affectiveImagery_CAMs, file = "affectiveImagery_CAMs.rds")
```

## clean affective imagery


create relevant subset:

```{r}
#| echo: true
#| warning: false

affectiveImagery <- t12_questionnaireCAMs[, c("PROLIFIC_PID", "country.x", "classes_conspiracy", "politicalParty", "socio_sex",
  "mean_affImg",
  str_subset(string = colnames(tmp_dat), pattern = "^R[:digit:]"), 
  sort(str_subset(string = colnames(tmp_dat), pattern = "^affImg")))]
sum(is.na(affectiveImagery$mean_affImg))
```


use approximate matching only for German (not run automatically!):

```{r}
#| eval: false


subset_affectiveImagery <- affectiveImagery[affectiveImagery$country.x == "Germany",]

tmp_vec <- unlist(subset_affectiveImagery[, str_subset(string = colnames(tmp_dat), pattern = "^R[:digit:]")])
tmp_vec <- tmp_vec[!is.na(tmp_vec)]

applyApproximate <- data.frame(originalWord = tmp_vec, summarizedWord = tmp_vec)


rm(subset_affectiveImagery); rm(tmp_vec)

length(applyApproximate$originalWord)
length(unique(applyApproximate$originalWord))
names(table(applyApproximate$originalWord))[table(applyApproximate$originalWord) >= 10]


readkey <- function()
{
  # cat ('\nPress [enter] to continue\n')
  # cat('or write "aaa" in the console to terminate loop\n')

  line <- readline()
  if(line == "a123"){
    cat("for loop terminated, please write down the last round where you have summarized words:",
        i, "\n")
    stop("process terminated")
  }else{
    return(line)
  }
}

defineDistance = 2

for(i in 1:nrow(applyApproximate)){
  print(i)
  
  dist <- stringdist::stringdist(a = applyApproximate$summarizedWord[i], applyApproximate$summarizedWord)


  
if(!all(unique(applyApproximate$summarizedWord[dist <= defineDistance]) == applyApproximate$summarizedWord[i])){
  
  cat("\n if you want to summarize the followings words:\n")
  print(unique(applyApproximate$summarizedWord[dist <= defineDistance]))
  
  cat('>>> provide a superordinate word, else write "c" (for continue) or write "a123" to stop the summary process')

 
  out <- readkey() 
  # print(out)
  
  if(out != "c"){
      applyApproximate$summarizedWord[applyApproximate$summarizedWord %in% unique(applyApproximate$summarizedWord[dist <= defineDistance])] <- out
  }
}
}


### save data set
setwd("outputs/BA_Magdalena")
if(!file.exists("data")){
  dir.create("data_AffImg")
}
setwd("data_AffImg")

## save as .xlsx file
xlsx::write.xlsx2(x = applyApproximate, file = "applyApproximate.xlsx")
## save as .csv file
write.csv2(x = applyApproximate, file = "applyApproximate.csv")
## save as R object
saveRDS(applyApproximate, file = "applyApproximate.rds")
```

## overwrite affective imagery

### create long format data

```{r}
### create long format data
counter = 1
for(p in affectiveImagery$PROLIFIC_PID){
  tmp_dat <- affectiveImagery[affectiveImagery$PROLIFIC_PID == p, ]
  
  tmp_vec_word <- unlist(tmp_dat[, str_subset(string = colnames(tmp_dat), pattern = "^R[:digit:]")])
  tmp_vec_word <- tmp_vec_word[!is.na(tmp_vec_word)]
  
  
    tmp_vec_valence <- unlist(tmp_dat[, str_subset(string = colnames(tmp_dat), pattern = "^affImgAffect")])
  tmp_vec_valence <- tmp_vec_valence[!is.na(tmp_vec_valence)]
  
  if(length(tmp_vec_word) != length(tmp_vec_valence)){
    tmp_vec_valence <- rep(NA, times = length(tmp_vec_word))
  }
  
  if(length(tmp_vec_word) == 0 & length(tmp_vec_valence) == 0){
    tmp_vec_word <- NA
    tmp_vec_valence <- NA
  }
  
  if(counter == 1){
    dat_out <- data.frame(PROLIFIC_PID = tmp_dat$PROLIFIC_PID, 
             country = tmp_dat$country.x,
             class_conspiracy = tmp_dat$classes_conspiracy, 
             originalWord = tmp_vec_word,
             valence = tmp_vec_valence)
  }else{
    dat_out <- rbind(dat_out, data.frame(PROLIFIC_PID = tmp_dat$PROLIFIC_PID, 
             country = tmp_dat$country.x,
             class_conspiracy = tmp_dat$classes_conspiracy, 
             originalWord = tmp_vec_word,
             valence = tmp_vec_valence))
  }
  
  counter = counter + 1
}
```


### overwrite approximate matching

```{r}
setwd("data_BA_Magdalena")

overwriteApproximate <- read.xlsx2(file = "AffectiveImageryDataGermanSummarised.xlsx", sheetIndex = 1)


dat_out$summarizedWord <- dat_out$originalWord
# w <- "Real"

length(unique(dat_out$summarizedWord))

for(w in unique(overwriteApproximate$originalWord)){
  dat_out$summarizedWord[dat_out$originalWord %in% w & dat_out$country == "Germany"] <- overwriteApproximate$summarizedWord_final[overwriteApproximate$originalWord %in% w]
}

length(unique(dat_out$summarizedWord))


setwd("..")

### save data set
setwd("outputs/BA_Magdalena")
if(!file.exists("data_AffImg_processed")){
  dir.create("data_AffImg_processed")
}
setwd("data_AffImg_processed")

## save as .xlsx file
xlsx::write.xlsx2(x = dat_out, file = "affImg.xlsx")
## save as .csv file
write.csv2(x = dat_out, file = "affImg.csv")
## save as R object
saveRDS(dat_out, file = "affImg.rds")
```

### overwrite translated words

```{r}
setwd("data_BA_Magdalena")

overwriteApproximate <- read.xlsx2(file = "AffectiveImageryDataGermanTranslated.xlsx", sheetIndex = 1)

overwriteApproximate <- overwriteApproximate[overwriteApproximate$country == "Germany", ]


# dat_out$summarizedWord <- dat_out$originalWord
# w <-  unique(overwriteApproximate$originalWord)[2]

length(unique(dat_out$summarizedWord))

for(w in unique(overwriteApproximate$originalWord)){
  dat_out$summarizedWord[dat_out$originalWord %in% w & dat_out$country == "Germany"] <- overwriteApproximate$summarizedWord_final[overwriteApproximate$originalWord %in% w]
}

length(unique(dat_out$summarizedWord))


setwd("..")

# ### save data set
setwd("outputs/BA_Magdalena")
if(!file.exists("data_AffImg_processed")){
  dir.create("data_AffImg_processed")
}
setwd("data_AffImg_processed")

## save as .xlsx file
xlsx::write.xlsx2(x = dat_out, file = "affImg_translated.xlsx")
## save as .csv file
write.csv2(x = dat_out, file = "affImg_translated.csv")
## save as R object
saveRDS(dat_out, file = "affImg_translated.rds")
```

### statistics

```{r}
dat_out %>%
  group_by(class_conspiracy) %>%
  summarise(N = n(), mean = mean(valence, na.rm = TRUE))


dat_out %>%
  group_by(class_conspiracy, country) %>%
  summarise(N = n(), mean = mean(valence, na.rm = TRUE))
```


## clean affective imagery after translation

use approximate matching for English and German (not run automatically!):

```{r}
#| eval: false


## remove NAs
dat_out$summarizedWord[is.na(dat_out$summarizedWord)] <- ""

readkey <- function()
{
  # cat ('\nPress [enter] to continue\n')
  # cat('or write "aaa" in the console to terminate loop\n')

  line <- readline()
  if(line == "a123"){
    cat("for loop terminated, please write down the last round where you have summarized words:",
        i, "\n")
    stop("process terminated")
  }else{
    return(line)
  }
}

defineDistance = 1




for(i in 1:nrow(dat_out)){
  print(i)
  
  dist <- stringdist::stringdist(a = dat_out$summarizedWord[i], dat_out$summarizedWord)


  
if(!all(unique(dat_out$summarizedWord[dist <= defineDistance]) == dat_out$summarizedWord[i])){
  
  cat("\n if you want to summarize the followings words:\n")
  print(unique(dat_out$summarizedWord[dist <= defineDistance]))
  
  cat('>>> provide a superordinate word, else write "c" (for continue) or write "a123" to stop the summary process')

 
  out <- readkey() 
  # print(out)
  
  if(out != "c"){
      dat_out$summarizedWord[dat_out$summarizedWord %in% unique(dat_out$summarizedWord[dist <= defineDistance])] <- out
  }
}
}




### save data set
setwd("outputs/BA_Magdalena")
if(!file.exists("data_AffImg")){
  dir.create("data_AffImg")
}
setwd("data_AffImg")

## save as .xlsx file
xlsx::write.xlsx2(x = applyApproximate, file = "applyApproximate_translated.xlsx")
## save as .csv file
write.csv2(x = applyApproximate, file = "applyApproximate_translated.csv")
## save as R object
saveRDS(applyApproximate, file = "applyApproximate_translated.rds")
```



## get tables for ratings

```{r}
### save data set
setwd("outputs/BA_Magdalena")
if(!file.exists("savedWordlists_combined")){
  dir.create("savedWordlists_combined")
}
setwd("savedWordlists_combined")

### create tables for ratings
for(i in 1:length(unique(CAMfiles[[1]]$participantCAM))){
  
  ## t1 - Affective Imagery
  tmp_associations <- dat_out[dat_out$PROLIFIC_PID %in% unique(CAMfiles[[1]]$participantCAM)[i], ]

  ## t2 - CAM
  tmp_concepts <- CAMfiles[[1]][CAMfiles[[1]]$participantCAM %in% unique(CAMfiles[[1]]$participantCAM)[i], ]

  ## add variables Affective Imagery
  tmp_associations$type <- "Affective Imagery"
  tmp_associations$Rating_Magdalena <- NA
  tmp_associations$Comment_Magdalena <- NA
  
  tmp_associations$id <- NA
  tmp_associations$comment <- NA
  
  tmp_associations <- tmp_associations[, c("type", "PROLIFIC_PID", "id", "summarizedWord", "valence", "comment", "Rating_Magdalena", "Comment_Magdalena")]

  colnames(tmp_associations)[4] <- "text"
  
  ## add variables CAM
  tmp_concepts$type <- "CAM"
  tmp_concepts$Rating_Magdalena <- NA
  tmp_concepts$Comment_Magdalena <- NA
  
  ## order chronologically
  tmp_concepts <- tmp_concepts[order(tmp_concepts$dateConceptCreated), ]
  tmp_concepts <- tmp_concepts[1:9, ] # first 8 concepts

  
  tmp_concepts <- tmp_concepts[, c("type", "participantCAM", "id", "text", "value", "comment", "Rating_Magdalena", "Comment_Magdalena")]
  
  colnames(tmp_concepts)[2] <- "PROLIFIC_PID"
  colnames(tmp_concepts)[5] <- "valence"
  
  
  tmp_dat <- rbind(tmp_associations, tmp_concepts)

  if(i == 1){
    write.xlsx2(x = tmp_dat, file="ratingsAffimgCAMs.xlsx", sheetName=unique(tmp_concepts$PROLIFIC_PID), row.names=FALSE)
  }else{
    write.xlsx2(tmp_dat, file="ratingsAffimgCAMs.xlsx", sheetName=unique(tmp_concepts$PROLIFIC_PID), row.names=FALSE, append=TRUE)
  }
  
      write.xlsx2(x = tmp_dat, file=paste0(unique(tmp_concepts$PROLIFIC_PID), ".xlsx"), sheetName=unique(tmp_concepts$PROLIFIC_PID), row.names=FALSE)

}
```
```{r}
### save data set
setwd("outputs/BA_Magdalena")
setwd("savedWordlists_combined")

# file <- system.file("tests", "ratingsAffimgCAMs.xlsx", package = "xlsx")

wb <- loadWorkbook("ratingsAffimgCAMs.xlsx")
sheets <- getSheets(wb)
length(sheets)
```
